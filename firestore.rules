rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isProfessional() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'professional';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) && 
                      (!request.resource.data.keys().hasAny(['role']) || 
                       request.resource.data.role == 'user');
      
      // Users can update their own data, but NOT their role
      // Only admins can update roles
      allow update: if isOwner(userId) && 
                      !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) ||
                      isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // Professionals collection
    match /professionals/{professionalId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated();
      allow update: if isOwner(professionalId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Appointments collection
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.patientId == request.auth.uid ||
        resource.data.professionalId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Reviews collection
    match /reviews/{reviewId} {
      // Anyone authenticated can read reviews
      allow read: if isAuthenticated();
      
      // Only the patient can create a review
      allow create: if isAuthenticated() && 
                      request.resource.data.patientId == request.auth.uid &&
                      request.resource.data.status == 'pending' &&
                      request.resource.data.rating >= 1 &&
                      request.resource.data.rating <= 5 &&
                      request.resource.data.comment.size() >= 10 &&
                      request.resource.data.comment.size() <= 500;
      
      // Admins can update (moderate) reviews
      // Professionals can add responses to their own reviews
      allow update: if isAdmin() || (
        isAuthenticated() &&
        resource.data.professionalId == request.auth.uid &&
        resource.data.status == 'approved' &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['professionalResponse', 'professionalResponseDate', 'hasResponse']) &&
        request.resource.data.professionalResponse.size() >= 10 &&
        request.resource.data.professionalResponse.size() <= 500
      );
      
      // Only admins can delete reviews
      allow delete: if isAdmin();
    }
    
    // Review Reports collection
    match /reviewReports/{reportId} {
      // Anyone can create a report
      allow create: if isAuthenticated() &&
                      request.resource.data.reporterId == request.auth.uid &&
                      request.resource.data.reason.size() >= 10;
      
      // Only admins can read and update reports
      allow read, update: if isAdmin();
      
      // Only admins can delete reports
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // System can create notifications (via Cloud Functions or admin)
      allow create: if isAuthenticated();
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Only admins can delete notifications
      allow delete: if isAdmin();
    }
    
    // Audit Logs collection
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Logs are immutable
    }
    
    // Categories collection
    match /categories/{categoryId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
